/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: customer-presentation.isl.md
 * Edit the ISL file instead.
 */

import React, { useState, useEffect, useCallback } from 'react';
import {
  fetchCustomers,
  fetchCustomerProfile,
  updateCustomerProfile,
  // deactivateCustomer // Not used in current capabilities, but available if needed.
} from './customer-logic';

// Helper for basic client-side validation
const validateCustomerUpdates = (updates) => {
  const errors = {};
  if (updates.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(updates.email)) {
    errors.email = 'Invalid email format';
  }
  if (updates.firstName != null && updates.firstName.trim() === '') {
    errors.firstName = 'First name cannot be empty';
  }
  if (updates.lastName != null && updates.lastName.trim() === '') {
    errors.lastName = 'Last name cannot be empty';
  }
  // Add more validation rules as needed for addresses, phone number, etc.
  // For simplicity, only basic fields are validated here.
  return Object.keys(errors).length === 0 ? null : errors;
};

// --- Internal Component: CustomerListView ---
const CustomerListView = ({
  customers = [],
  totalCount = 0,
  currentPage = 1,
  pageSize = 10,
  onPageChange,
  onSearch,
  onSelectCustomer,
  loading = false,
  error = null,
  currentSearchQuery = ''
}) => {
  const totalPages = Math.ceil(totalCount / pageSize);
  const [searchInputValue, setSearchInputValue] = useState(currentSearchQuery);

  // Sync internal search input state with prop if it changes externally
  useEffect(() => {
    setSearchInputValue(currentSearchQuery);
  }, [currentSearchQuery]);

  const handleSearchSubmit = (e) => {
    e.preventDefault();
    onSearch(searchInputValue);
  };

  return (
    <div className="p-4 border-r border-gray-200 w-1/2 flex flex-col">
      <h2 className="text-xl font-semibold mb-4">Customer List</h2>
      <form onSubmit={handleSearchSubmit} className="mb-4 flex">
        <input
          type="text"
          placeholder="Search customers..."
          className="flex-grow p-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          value={searchInputValue}
          onChange={(e) => setSearchInputValue(e.target.value)}
        />
        <button
          type="submit"
          className="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          Search
        </button>
      </form>

      {loading && <div className="text-center py-4">Loading customers...</div>}
      {error && <div className="text-red-600 text-center py-4">Error: {error}</div>}

      {!loading && !error && customers.length === 0 && (
        <div className="text-center py-4 text-gray-500">No customers found.</div>
      )}

      {!loading && !error && customers.length > 0 && (
        <div className="overflow-x-auto flex-grow">
          <table className="min-w-full bg-white border border-gray-200">
            <thead>
              <tr>
                <th className="py-2 px-4 border-b text-left">Name</th>
                <th className="py-2 px-4 border-b text-left">Email</th>
                <th className="py-2 px-4 border-b text-left">Status</th>
                <th className="py-2 px-4 border-b text-left">Orders</th>
              </tr>
            </thead>
            <tbody>
              {customers.map((customer) => (
                <tr
                  key={customer.id}
                  className="hover:bg-gray-50 cursor-pointer"
                  onClick={() => onSelectCustomer(customer.id)}
                >
                  <td className="py-2 px-4 border-b">{`${customer.firstName} ${customer.lastName}`}</td>
                  <td className="py-2 px-4 border-b">{customer.email}</td>
                  <td className="py-2 px-4 border-b">{customer.status}</td>
                  <td className="py-2 px-4 border-b">{customer.totalOrders}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {!loading && !error && totalPages > 1 && (
        <div className="flex justify-between items-center mt-4">
          <button
            onClick={() => onPageChange(currentPage - 1, pageSize)}
            disabled={currentPage === 1}
            className="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 disabled:opacity-50"
          >
            Previous
          </button>
          <span>
            Page {currentPage} of {totalPages}
          </span>
          <button
            onClick={() => onPageChange(currentPage + 1, pageSize)}
            disabled={currentPage === totalPages}
            className="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 disabled:opacity-50"
          >
            Next
          </button>
        </div>
      )}
    </div>
  );
};

// --- Internal Component: CustomerDetailView ---
const CustomerDetailView = ({
  customer = null,
  onUpdateCustomer,
  loading = false,
  error = null
}) => {
  const [isEditing, setIsEditing] = useState(false);
  const [formData, setFormData] = useState({});
  const [validationErrors, setValidationErrors] = useState({});
  const [updateLoading, setUpdateLoading] = useState(false);
  const [updateSuccess, setUpdateSuccess] = useState(false);
  const [updateError, setUpdateError] = useState(null);

  useEffect(() => {
    if (customer) {
      setFormData({
        firstName: customer.firstName,
        lastName: customer.lastName,
        email: customer.email,
        phoneNumber: customer.phoneNumber,
        shippingAddress: { ...customer.shippingAddress },
        billingAddress: { ...customer.billingAddress },
        status: customer.status,
      });
      setValidationErrors({});
      setUpdateSuccess(false);
      setUpdateError(null);
    } else {
      setFormData({});
    }
    setIsEditing(false); // Reset editing state when customer changes
  }, [customer]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));
    setValidationErrors((prev) => ({ ...prev, [name]: undefined })); // Clear error on change
  };

  const handleAddressChange = (addressType, e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [addressType]: {
        ...prev[addressType],
        [name]: value,
      },
    }));
  };

  const handleSave = async () => {
    const updates = { ...formData };
    const errors = validateCustomerUpdates(updates);

    if (errors) {
      setValidationErrors(errors);
      return;
    }

    setUpdateLoading(true);
    setUpdateError(null);
    setUpdateSuccess(false);

    try {
      await onUpdateCustomer(customer.id, updates);
      setIsEditing(false);
      setUpdateSuccess(true);
      setTimeout(() => setUpdateSuccess(false), 3000); // Hide success message after 3 seconds
    } catch (err) {
      setUpdateError(err.message || 'Failed to update customer profile.');
    } finally {
      setUpdateLoading(false);
    }
  };

  if (loading) {
    return <div className="p-4 w-1/2 text-center">Loading customer details...</div>;
  }

  if (error) {
    return <div className="p-4 w-1/2 text-red-600 text-center">Error: {error}</div>;
  }

  if (!customer) {
    return <div className="p-4 w-1/2 text-center text-gray-500">Select a customer to view details.</div>;
  }

  return (
    <div className="p-4 w-1/2 flex flex-col">
      <h2 className="text-xl font-semibold mb-4">Customer Profile: {customer.firstName} {customer.lastName}</h2>

      {updateSuccess && (
        <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
          Profile updated successfully!
        </div>
      )}
      {updateError && (
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
          {updateError}
        </div>
      )}

      <div className="flex-grow overflow-y-auto">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label className="block text-sm font-medium text-gray-700">First Name</label>
            {isEditing ? (
              <>
                <input
                  type="text"
                  name="firstName"
                  value={formData.firstName || ''}
                  onChange={handleChange}
                  className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                />
                {validationErrors.firstName && <p className="text-red-500 text-xs mt-1">{validationErrors.firstName}</p>}
              </>
            ) : (
              <p className="mt-1 text-gray-900">{customer.firstName}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Last Name</label>
            {isEditing ? (
              <>
                <input
                  type="text"
                  name="lastName"
                  value={formData.lastName || ''}
                  onChange={handleChange}
                  className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                />
                {validationErrors.lastName && <p className="text-red-500 text-xs mt-1">{validationErrors.lastName}</p>}
              </>
            ) : (
              <p className="mt-1 text-gray-900">{customer.lastName}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Email</label>
            {isEditing ? (
              <>
                <input
                  type="email"
                  name="email"
                  value={formData.email || ''}
                  onChange={handleChange}
                  className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
                />
                {validationErrors.email && <p className="text-red-500 text-xs mt-1">{validationErrors.email}</p>}
              </>
            ) : (
              <p className="mt-1 text-gray-900">{customer.email}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Phone Number</label>
            {isEditing ? (
              <input
                type="text"
                name="phoneNumber"
                value={formData.phoneNumber || ''}
                onChange={handleChange}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.phoneNumber}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Status</label>
            {isEditing ? (
              <select
                name="status"
                value={formData.status || ''}
                onChange={handleChange}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              >
                <option value="ACTIVE">ACTIVE</option>
                <option value="INACTIVE">INACTIVE</option>
                <option value="PENDING">PENDING</option>
              </select>
            ) : (
              <p className="mt-1 text-gray-900">{customer.status}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Total Orders</label>
            <p className="mt-1 text-gray-900">{customer.totalOrders}</p>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Total Spent</label>
            <p className="mt-1 text-gray-900">${customer.totalSpent?.toFixed(2) || '0.00'}</p>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Created At</label>
            <p className="mt-1 text-gray-900">{new Date(customer.createdAt).toLocaleDateString()}</p>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Updated At</label>
            <p className="mt-1 text-gray-900">{new Date(customer.updatedAt).toLocaleDateString()}</p>
          </div>
        </div>

        <h3 className="text-lg font-medium text-gray-900 mb-2">Shipping Address</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label className="block text-sm font-medium text-gray-700">Street</label>
            {isEditing ? (
              <input
                type="text"
                name="street"
                value={formData.shippingAddress?.street || ''}
                onChange={(e) => handleAddressChange('shippingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.shippingAddress?.street}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">City</label>
            {isEditing ? (
              <input
                type="text"
                name="city"
                value={formData.shippingAddress?.city || ''}
                onChange={(e) => handleAddressChange('shippingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.shippingAddress?.city}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">State</label>
            {isEditing ? (
              <input
                type="text"
                name="state"
                value={formData.shippingAddress?.state || ''}
                onChange={(e) => handleAddressChange('shippingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.shippingAddress?.state}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Zip Code</label>
            {isEditing ? (
              <input
                type="text"
                name="zipCode"
                value={formData.shippingAddress?.zipCode || ''}
                onChange={(e) => handleAddressChange('shippingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.shippingAddress?.zipCode}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Country</label>
            {isEditing ? (
              <input
                type="text"
                name="country"
                value={formData.shippingAddress?.country || ''}
                onChange={(e) => handleAddressChange('shippingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.shippingAddress?.country}</p>
            )}
          </div>
        </div>

        <h3 className="text-lg font-medium text-gray-900 mb-2">Billing Address</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label className="block text-sm font-medium text-gray-700">Street</label>
            {isEditing ? (
              <input
                type="text"
                name="street"
                value={formData.billingAddress?.street || ''}
                onChange={(e) => handleAddressChange('billingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.billingAddress?.street}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">City</label>
            {isEditing ? (
              <input
                type="text"
                name="city"
                value={formData.billingAddress?.city || ''}
                onChange={(e) => handleAddressChange('billingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.billingAddress?.city}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">State</label>
            {isEditing ? (
              <input
                type="text"
                name="state"
                value={formData.billingAddress?.state || ''}
                onChange={(e) => handleAddressChange('billingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.billingAddress?.state}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Zip Code</label>
            {isEditing ? (
              <input
                type="text"
                name="zipCode"
                value={formData.billingAddress?.zipCode || ''}
                onChange={(e) => handleAddressChange('billingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.billingAddress?.zipCode}</p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Country</label>
            {isEditing ? (
              <input
                type="text"
                name="country"
                value={formData.billingAddress?.country || ''}
                onChange={(e) => handleAddressChange('billingAddress', e)}
                className="mt-1 block w-full p-2 border border-gray-300 rounded-md"
              />
            ) : (
              <p className="mt-1 text-gray-900">{customer.billingAddress?.country}</p>
            )}
          </div>
        </div>
      </div>

      <div className="mt-4 flex justify-end space-x-2">
        {isEditing ? (
          <>
            <button
              onClick={() => {
                setIsEditing(false);
                setValidationErrors({});
                setUpdateError(null);
                // Reset form data to original customer data if editing is cancelled
                if (customer) {
                  setFormData({
                    firstName: customer.firstName,
                    lastName: customer.lastName,
                    email: customer.email,
                    phoneNumber: customer.phoneNumber,
                    shippingAddress: { ...customer.shippingAddress },
                    billingAddress: { ...customer.billingAddress },
                    status: customer.status,
                  });
                }
              }}
              className="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400"
              disabled={updateLoading}
            >
              Cancel
            </button>
            <button
              onClick={handleSave}
              className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
              disabled={updateLoading}
            >
              {updateLoading ? 'Saving...' : 'Save Changes'}
            </button>
          </>
        ) : (
          <button
            onClick={() => setIsEditing(true)}
            className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
          >
            Edit Profile
          </button>
        )}
      </div>
    </div>
  );
};

// --- Main Component: CustomerPresentation ---
export default function CustomerPresentation({ initialPage = 1, pageSize = 10 }) {
  const [currentPage, setCurrentPage] = useState(initialPage);
  const [currentSize, setCurrentSize] = useState(pageSize); // State for pageSize to allow UI changes
  const [currentSearchQuery, setCurrentSearchQuery] = useState('');
  const [currentSortField, setCurrentSortField] = useState(null);
  const [currentSortOrder, setCurrentSortOrder] = useState(null);
  const [customerList, setCustomerList] = useState([]);
  const [totalCustomers, setTotalCustomers] = useState(0);
  const [listLoading, setListLoading] = useState(false);
  const [listError, setListError] = useState(null);

  const [selectedCustomerId, setSelectedCustomerId] = useState(null);
  const [customerDetail, setCustomerDetail] = useState(null);
  const [detailLoading, setDetailLoading] = useState(false);
  const [detailError, setDetailError] = useState(null);

  // Sync initialPage and pageSize props with state if they change externally
  useEffect(() => setCurrentPage(initialPage), [initialPage]);
  useEffect(() => setCurrentSize(pageSize), [pageSize]);

  // Capability: displayCustomerList
  const displayCustomerList = useCallback(async (page, size, searchQuery, sortField, sortOrder) => {
    setListLoading(true);
    setListError(null);
    try {
      const filters = {
        searchQuery: searchQuery || null,
        // The ISL mentions `filterCriteria: Object` in handleSearchAndFilter,
        // but `fetchCustomers` only explicitly supports `status` and `searchQuery`.
        // For now, only searchQuery is passed. If more filters were needed,
        // they would be added to the filters object here.
        // E.g., status: filterCriteria?.status || null,
      };
      const data = await fetchCustomers(page, size, filters);
      setCustomerList(data.customers);
      setTotalCustomers(data.totalCount);
    } catch (err) {
      setListError(err.message || 'Failed to fetch customer list.');
      setCustomerList([]);
      setTotalCustomers(0);
    } finally {
      setListLoading(false);
    }
  }, []);

  // Capability: displayCustomerDetail
  const displayCustomerDetail = useCallback(async (customerId) => {
    if (!customerId) {
      setCustomerDetail(null);
      setDetailError(null);
      return;
    }
    setDetailLoading(true);
    setDetailError(null);
    try {
      const data = await fetchCustomerProfile(customerId);
      setCustomerDetail(data);
    } catch (err) {
      setDetailError(err.message || 'Failed to fetch customer profile.');
      setCustomerDetail(null);
    } finally {
      setDetailLoading(false);
    }
  }, []);

  // Effect for initial load and subsequent list updates (displayCustomerList)
  useEffect(() => {
    displayCustomerList(currentPage, currentSize, currentSearchQuery, currentSortField, currentSortOrder);
  }, [currentPage, currentSize, currentSearchQuery, currentSortField, currentSortOrder, displayCustomerList]);

  // Effect for loading customer detail when selectedCustomerId changes (displayCustomerDetail)
  useEffect(() => {
    displayCustomerDetail(selectedCustomerId);
  }, [selectedCustomerId, displayCustomerDetail]);

  // Capability: handleCustomerSelection
  const handleCustomerSelection = useCallback((customerId) => {
    setSelectedCustomerId(customerId);
  }, []);

  // Capability: handleCustomerProfileUpdate
  const handleCustomerProfileUpdate = useCallback(async (customerId, updates) => {
    try {
      // Client-side validation is performed in CustomerDetailView before this function is called.
      const updatedCustomer = await updateCustomerProfile(customerId, updates);
      // Upon successful update, refresh the detail view with the latest data
      // The `updatedCustomer` returned by `updateCustomerProfile` could also be used directly,
      // but re-fetching ensures consistency with the backend state.
      await displayCustomerDetail(customerId);
      // The CustomerDetailView will handle success notification via its own state
    } catch (err) {
      console.error('Customer profile update failed:', err);
      throw err; // Re-throw to allow CustomerDetailView to catch and display the error
    }
  }, [displayCustomerDetail]);

  // Capability: handlePaginationChange
  const handlePaginationChange = useCallback((newPage, newSize = currentSize) => {
    setCurrentPage(newPage);
    if (newSize !== currentSize) {
      setCurrentSize(newSize);
    }
  }, [currentSize]);

  // Capability: handleSearchAndFilter
  const handleSearchAndFilter = useCallback((searchQuery, filterCriteria = {}) => {
    setCurrentSearchQuery(searchQuery);
    // If filterCriteria were to be used, a state for it would be needed.
    // E.g., setCurrentFilterCriteria(filterCriteria);
    setCurrentPage(1); // Reset page to 1 on new search/filter
  }, []);

  return (
    <div className="flex h-screen bg-gray-100">
      <CustomerListView
        customers={customerList}
        totalCount={totalCustomers}
        currentPage={currentPage}
        pageSize={currentSize}
        onPageChange={handlePaginationChange}
        onSearch={handleSearchAndFilter}
        onSelectCustomer={handleCustomerSelection}
        loading={listLoading}
        error={listError}
        currentSearchQuery={currentSearchQuery}
      />
      <CustomerDetailView
        customer={customerDetail}
        onUpdateCustomer={handleCustomerProfileUpdate}
        loading={detailLoading}
        error={detailError}
      />
    </div>
  );
}