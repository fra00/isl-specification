/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: main.isl.md
 * Edit the ISL file instead.
 */

import React, { useState, useRef, useEffect, useCallback } from "react";

// Imports from REAL IMPLEMENTATION CONTEXT
import { GameLogic } from "./game-logic";
import GameBoardPresentation from "./game-board-presentation";
import HudPresentation from "./hud-presentation";
import StartGamePresentation from "./start-game-presentation";
import {
  GameConfig,
  LevelConfig,
  GameStatusEnum,
  PlayerActionEnum,
} from "./game-domain";

const Main = () => {
  // Capability: initializeApplication
  // Define gameConfig object using GameConfig factory
  const gameConfigRef = useRef(
    GameConfig({
      canvasWidth: 800,
      canvasHeight: 600,
      playerBulletCooldown: 500,
      maxLevels: 10,
      // Default values for other GameConfig properties not explicitly mentioned in the flow
      playerBaseSpeed: 200,
      playerBulletBaseSpeed: 400,
      invaderBaseSpeed: 25, //50,
      invaderBulletBaseSpeed: 200,
      invaderShotBaseFrequency: 2000,
      invaderHorizontalSpacing: 30, // 40
      invaderVerticalSpacing: 15,
      invaderDescentAmount: 5, //20
      initialLives: 3,
      shieldCount: 4, // From shieldConfig in flow
      shieldSegmentHealth: 3, // From shieldConfig in flow
      scorePerInvader: 10,
      scorePerUFO: 100,
      scorePerLevelClear: 500,
    }),
  );

  // Level configurations as per initializeApplication flow
  const levelConfigs = [
    LevelConfig({
      levelNumber: 1,
      invaderRows: 5,
      invaderCols: 10,
      invaderSpeedMultiplier: 1.0,
      invaderBulletSpeedMultiplier: 1.0,
      invaderShotFrequencyMultiplier: 1.0,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 2,
      invaderRows: 5,
      invaderCols: 10,
      invaderSpeedMultiplier: 1.1,
      invaderBulletSpeedMultiplier: 1.05,
      invaderShotFrequencyMultiplier: 0.95,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 3,
      invaderRows: 6,
      invaderCols: 10,
      invaderSpeedMultiplier: 1.2,
      invaderBulletSpeedMultiplier: 1.1,
      invaderShotFrequencyMultiplier: 0.9,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 4,
      invaderRows: 6,
      invaderCols: 11,
      invaderSpeedMultiplier: 1.3,
      invaderBulletSpeedMultiplier: 1.15,
      invaderShotFrequencyMultiplier: 0.85,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 5,
      invaderRows: 7,
      invaderCols: 11,
      invaderSpeedMultiplier: 1.4,
      invaderBulletSpeedMultiplier: 1.2,
      invaderShotFrequencyMultiplier: 0.8,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 6,
      invaderRows: 7,
      invaderCols: 12,
      invaderSpeedMultiplier: 1.5,
      invaderBulletSpeedMultiplier: 1.25,
      invaderShotFrequencyMultiplier: 0.75,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 7,
      invaderRows: 8,
      invaderCols: 12,
      invaderSpeedMultiplier: 1.6,
      invaderBulletSpeedMultiplier: 1.3,
      invaderShotFrequencyMultiplier: 0.7,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 8,
      invaderRows: 8,
      invaderCols: 13,
      invaderSpeedMultiplier: 1.7,
      invaderBulletSpeedMultiplier: 1.35,
      invaderShotFrequencyMultiplier: 0.65,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 9,
      invaderRows: 9,
      invaderCols: 13,
      invaderSpeedMultiplier: 1.8,
      invaderBulletSpeedMultiplier: 1.4,
      invaderShotFrequencyMultiplier: 0.6,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
    LevelConfig({
      levelNumber: 10,
      invaderRows: 9,
      invaderCols: 14,
      invaderSpeedMultiplier: 2.0,
      invaderBulletSpeedMultiplier: 1.5,
      invaderShotFrequencyMultiplier: 0.55,
      playerBulletSpeedMultiplier: 1.0,
      playerSpeedMultiplier: 1.0,
      initialPlayerLives: 3,
      shieldConfiguration: [],
    }),
  ];
  // Add levelConfigs to gameConfigRef.current
  gameConfigRef.current = { ...gameConfigRef.current, levelConfigs };

  // Instantiate the GameLogic component once using useRef
  const gameLogicRef = useRef(GameLogic(gameConfigRef.current));

  // Obtain the initial gameState by requesting GameLogic.initializeGame()
  const [gameState, setGameState] = useState(() =>
    gameLogicRef.current.initializeGame(),
  );

  // Ref to hold the latest gameState for the game loop to prevent stale closures
  const gameStateRef = useRef(gameState);
  useEffect(() => {
    gameStateRef.current = gameState;
  }, [gameState]);

  // Capability: handlePlayerAction
  const handlePlayerAction = useCallback((action, isPressed) => {
    setGameState((prevGameState) =>
      gameLogicRef.current.processPlayerInput(prevGameState, action, isPressed),
    );
  }, []);

  // Capability: handleStartGameRequest
  const handleStartGameRequest = useCallback((stateToStart) => {
    setGameState(gameLogicRef.current.startGame(stateToStart));
  }, []);

  // Capability: handleResetGameRequest
  const handleResetGameRequest = useCallback((stateToReset) => {
    setGameState(gameLogicRef.current.resetGame(stateToReset));
  }, []);

  // Keyboard input handling (delegated from GameBoardPresentation.handleKeyboardInput)
  useEffect(() => {
    const handleKeyDown = (event) => {
      // Prevent default for spacebar to avoid scrolling
      if (event.key === " ") {
        event.preventDefault();
      }
      switch (event.key) {
        case "ArrowLeft":
        case "a":
          handlePlayerAction(PlayerActionEnum.MOVE_LEFT, true);
          break;
        case "ArrowRight":
        case "d":
          handlePlayerAction(PlayerActionEnum.MOVE_RIGHT, true);
          break;
        case " ": // Spacebar
          handlePlayerAction(PlayerActionEnum.SHOOT, true);
          break;
        default:
          break;
      }
    };

    const handleKeyUp = (event) => {
      switch (event.key) {
        case "ArrowLeft":
        case "a":
          handlePlayerAction(PlayerActionEnum.MOVE_LEFT, false);
          break;
        case "ArrowRight":
        case "d":
          handlePlayerAction(PlayerActionEnum.MOVE_RIGHT, false);
          break;
        case " ": // Spacebar
          handlePlayerAction(PlayerActionEnum.SHOOT, false);
          break;
        default:
          break;
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    window.addEventListener("keyup", handleKeyUp);

    return () => {
      window.removeEventListener("keydown", handleKeyDown);
      window.removeEventListener("keyup", handleKeyUp);
    };
  }, [handlePlayerAction]);

  // Capability: startGameLoop
  useEffect(() => {
    let animationFrameId;

    const gameLoop = (currentTime) => {
      // Update the gameState by requesting GameLogic.updateGame
      // Only update game logic if status is PLAYING
      if (gameStateRef.current.status === GameStatusEnum.PLAYING) {
        setGameState((prevGameState) => {
          let newState = gameLogicRef.current.updateGame(
            prevGameState,
            currentTime,
          );

          // Handle level cleared transition: if GameLogic.updateGame returns LEVEL_CLEARED,
          // and not max levels, then load next level.
          if (
            newState.status === GameStatusEnum.LEVEL_CLEARED &&
            newState.levelNumber < gameConfigRef.current.maxLevels
          ) {
            newState = gameLogicRef.current.loadNextLevel(newState);
          }
          return newState;
        });
      }
      // Schedule the next execution of startGameLoop using requestAnimationFrame
      animationFrameId = requestAnimationFrame(gameLoop);
    };

    animationFrameId = requestAnimationFrame(gameLoop);

    return () => {
      cancelAnimationFrame(animationFrameId);
    };
  }, []); // Empty dependency array to run once on mount

  // Render logic for the Main component
  return (
    <div
      className="relative bg-black overflow-hidden flex justify-center items-center"
      style={{
        width: gameConfigRef.current.canvasWidth,
        height: gameConfigRef.current.canvasHeight,
      }}
    >
      {/* GameBoardPresentation is always rendered as it's the main game area */}
      <GameBoardPresentation
        gameState={gameState}
        gameConfig={gameConfigRef.current}
        onPlayerAction={handlePlayerAction} // Passed for completeness, but Main handles global keyboard input
      />

      {/* HudPresentation is always rendered */}
      <HudPresentation gameState={gameState} />

      {/* StartGamePresentation is conditionally rendered based on game status */}
      {(gameState.status === GameStatusEnum.INITIAL ||
        gameState.status === GameStatusEnum.GAME_OVER ||
        gameState.status === GameStatusEnum.GAME_WON) && (
        <StartGamePresentation
          gameState={gameState}
          onStartGame={handleStartGameRequest}
          onResetGame={handleResetGameRequest}
        />
      )}
    </div>
  );
};

export default Main;
