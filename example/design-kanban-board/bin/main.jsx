/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: main.isl.md
 * Edit the ISL file instead.
 */

import React, { useState, useEffect, useRef, useCallback } from 'react';
import KanbanBoardView from './kanban-ui'; // Default export
import { createKanbanLogic } from './kanban-logic'; // Named export
import { BoardEntity, ColumnEntity } from './domain'; // Named exports

// Simulate persistence key for localStorage
const PERSISTENCE_KEY = 'kanbanBoardState';

export default function Main() {
  const [boardState, setBoardState] = useState(null);
  const kanbanLogicRef = useRef(null);

  // Capability: initializeApplication
  useEffect(() => {
    let initialBoard;
    try {
      // Declare a variable `persistedBoardState` to simulate persistent storage.
      const persistedBoardState = localStorage.getItem(PERSISTENCE_KEY);

      // TRY to load `BoardEntity` from `persistedBoardState`.
      if (persistedBoardState) {
        const parsedBoard = JSON.parse(persistedBoardState);
        // Basic validation to ensure it's a BoardEntity-like structure
        if (parsedBoard && Array.isArray(parsedBoard.columns)) {
          initialBoard = parsedBoard;
        } else {
          // CATCH if `persistedBoardState` is empty or invalid:
          console.warn("Invalid persisted board state found, creating default.");
          throw new Error("Invalid persisted state");
        }
      } else {
        throw new Error("No persisted state found");
      }
    } catch (error) {
      console.error("Error loading persisted board state:", error);
      // Create a default `BoardEntity` with a single column titled "To Do".
      initialBoard = BoardEntity({
        columns: [ColumnEntity({ title: "To Do" })]
      });
      // Set `persistedBoardState` to this default `BoardEntity`.
      localStorage.setItem(PERSISTENCE_KEY, JSON.stringify(initialBoard));
    }

    // Initialize `KanbanLogic` with the loaded or default `BoardEntity`.
    kanbanLogicRef.current = createKanbanLogic(initialBoard);

    // Set up a mechanism to listen for state changes from `KanbanLogic`.
    // The `KanbanLogic` functions return the new board state, so we'll update
    // our local state and persistence after each call.
    // For initial render, retrieve the current state.
    setBoardState(kanbanLogicRef.current.getBoardState());

  }, []); // Empty dependency array means this runs once on mount

  // Helper function to update the React state and simulated persistence
  // WHEN `KanbanLogic` indicates a state change:
  // - Retrieve the updated `BoardEntity` from `KanbanLogic` using `getBoardState`.
  // - Update `persistedBoardState` with the new `BoardEntity`.
  // - Trigger a re-render of the `KanbanBoardView`.
  const updateBoardAndPersist = useCallback(() => {
    if (kanbanLogicRef.current) {
      const newBoard = kanbanLogicRef.current.getBoardState();
      localStorage.setItem(PERSISTENCE_KEY, JSON.stringify(newBoard));
      setBoardState(newBoard);
    }
  }, []);

  // Pass the following `KanbanLogic` capabilities as props to `KanbanBoardView`,
  // wrapping them to ensure state and persistence are updated.
  const onAddColumn = useCallback((title) => {
    kanbanLogicRef.current?.addColumn(title);
    updateBoardAndPersist();
  }, [updateBoardAndPersist]);

  const onRenameColumn = useCallback((columnId, newTitle) => {
    kanbanLogicRef.current?.renameColumn(columnId, newTitle);
    updateBoardAndPersist();
  }, [updateBoardAndPersist]);

  const onDeleteColumn = useCallback((columnId) => {
    kanbanLogicRef.current?.deleteColumn(columnId);
    updateBoardAndPersist();
  }, [updateBoardAndPersist]);

  const onAddTask = useCallback((columnId, taskDetails) => {
    kanbanLogicRef.current?.addTask(columnId, taskDetails);
    updateBoardAndPersist();
  }, [updateBoardAndPersist]);

  const onUpdateTask = useCallback((columnId, taskId, updatedDetails) => {
    kanbanLogicRef.current?.updateTask(columnId, taskId, updatedDetails);
    updateBoardAndPersist();
  }, [updateBoardAndPersist]);

  const onDeleteTask = useCallback((columnId, taskId) => {
    kanbanLogicRef.current?.deleteTask(columnId, taskId);
    updateBoardAndPersist();
  }, [updateBoardAndPersist]);

  const onMoveTask = useCallback((currentColumnId, taskId, direction) => {
    kanbanLogicRef.current?.moveTask(currentColumnId, taskId, direction);
    updateBoardAndPersist();
  }, [updateBoardAndPersist]);

  // Capability: renderKanbanBoard
  // Retrieve the current `BoardEntity` from `KanbanLogic` using `getBoardState`.
  // (This is implicitly handled by `boardState` being updated via `setBoardState`)
  if (!boardState) {
    return (
      <div className="flex items-center justify-center h-screen text-lg text-gray-700">
        Loading Kanban Board...
      </div>
    );
  }

  // Display the `KanbanBoardView` component.
  return (
    <div className="min-h-screen bg-gray-100 p-4">
      <h1 className="text-3xl font-bold text-center mb-6 text-gray-800">My Kanban Board</h1>
      <KanbanBoardView
        board={boardState} // Pass the current `BoardEntity` as `board` prop to `KanbanBoardView`.
        onAddColumn={onAddColumn}
        onRenameColumn={onRenameColumn}
        onDeleteColumn={onDeleteColumn}
        onAddTask={onAddTask}
        onUpdateTask={onUpdateTask}
        onDeleteTask={onDeleteTask}
        onMoveTask={onMoveTask}
      />
    </div>
  );
}