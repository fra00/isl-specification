/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: main.isl.md
 * Edit the ISL file instead.
 */

import React, { useState, useEffect, useCallback, useRef } from 'react';
// Import GameStatus from domain as it's used directly for props
import { GameStatus } from './domain';
// Import all necessary functions from game-logic
import {
  initializeGame,
  flipCard,
  resetGame,
  startGameTimer,
  stopGameTimer,
  getCards,
  getMoves,
  constgetTimerSeconds, // Using the exact name from REAL IMPLEMENTATION CONTEXT
  getGameStatus,
} from './game-logic';
// Import default exports for components
import GameBoardComponent from './game-board';
import ScoreBoardComponent from './score-board';

export default function Main() {
  // State variables to hold the game data for presentation
  const [cards, setCards] = useState([]);
  const [moves, setMoves] = useState(0);
  const [timerSeconds, setTimerSeconds] = useState(0);
  const [gameStatus, setGameStatus] = useState(GameStatus.NotStarted);

  // Ref to store the timer interval ID, allowing cleanup
  const timerIntervalRef = useRef(null);

  // Helper function to update all relevant game state from the game-logic module.
  // This is called after actions that might change multiple state aspects.
  const updateAllGameState = useCallback(() => {
    setCards(getCards());
    setMoves(getMoves());
    setTimerSeconds(constgetTimerSeconds());
    setGameStatus(getGameStatus());
  }, []);

  // Capability: initializeGame (from ISL)
  // Contract: Initializes the game engine and starts the game.
  // Flow:
  // 1. Request GameEngine to initializeGame.
  // 2. Request GameEngine to startGameTimer.
  // Side Effects: Updates the internal state of the GameEngine.
  const initializeGameAndTimer = useCallback(() => {
    initializeGame();
    startGameTimer();
    // Immediately update local state after initialization
    updateAllGameState();
  }, [updateAllGameState]);

  // Capability: handleCardFlip (from ISL)
  // Contract: Passes a card flip event to the game engine.
  // Flow:
  // 1. Request GameEngine to flipCard with cardId.
  // Side Effects: Updates the internal state of the GameEngine.
  const handleCardFlip = useCallback((cardId) => {
    flipCard(cardId);
    // After a card flip, update all relevant state to reflect changes
    updateAllGameState();
  }, [updateAllGameState]);

  // Capability: handleResetGame (from ISL)
  // Contract: Resets the game through the game engine.
  // Flow:
  // 1. Request GameEngine to resetGame.
  // 2. Request GameEngine to startGameTimer.
  // Side Effects: Resets the internal state of the GameEngine.
  const handleResetGame = useCallback(() => {
    stopGameTimer(); // Ensure any existing timer is stopped before resetting
    resetGame();
    startGameTimer(); // Start the timer again for the new game
    // Update all relevant state immediately after reset
    updateAllGameState();
  }, [updateAllGameState]);

  // Effect for initial game setup and continuous timer updates
  useEffect(() => {
    // Acceptance Criteria: Upon initial load, the game is initialized and the timer starts.
    initializeGameAndTimer();

    // Set up an interval to periodically update the timer and check game status
    timerIntervalRef.current = setInterval(() => {
      const currentTimerSeconds = constgetTimerSeconds();
      setTimerSeconds(currentTimerSeconds);

      const currentStatus = getGameStatus();
      // Only update gameStatus state if it has actually changed to avoid unnecessary re-renders
      if (currentStatus !== gameStatus) {
        setGameStatus(currentStatus);
        // If the game is won or paused, stop the timer
        if (currentStatus === GameStatus.Won || currentStatus === GameStatus.Paused) {
          stopGameTimer();
          if (timerIntervalRef.current) {
            clearInterval(timerIntervalRef.current);
            timerIntervalRef.current = null;
          }
          // After game ends, ensure all state is updated one last time
          updateAllGameState();
        }
      }
    }, 1000); // Update every second

    // Cleanup function for when the component unmounts
    return () => {
      if (timerIntervalRef.current) {
        clearInterval(timerIntervalRef.current);
        timerIntervalRef.current = null;
      }
      stopGameTimer(); // Ensure the game timer is stopped
    };
  }, [initializeGameAndTimer, gameStatus, updateAllGameState]); // gameStatus and updateAllGameState are dependencies to react to their changes

  // Render the main application layout
  return (
    <div className="flex flex-col items-center p-4 space-y-4 bg-gray-100 min-h-screen">
      <h1 className="text-4xl font-bold text-blue-700 mb-6">Memory Game</h1>
      <ScoreBoardComponent
        moves={moves}
        timerSeconds={timerSeconds}
        gameStatus={gameStatus}
        onResetGame={handleResetGame}
      />
      <GameBoardComponent
        cards={cards}
        // gridSize is required by GameBoardComponent.
        // The ISL for Main does not specify how to obtain gridSize dynamically from game-logic.
        // GameConfig exists, and initGameEngine takes gridSize, but there's no getter for it in the provided signatures.
        // Using a common default [4, 4] as a pragmatic solution.
        gridSize={[4, 4]}
        onCardFlip={handleCardFlip}
      />
    </div>
  );
}