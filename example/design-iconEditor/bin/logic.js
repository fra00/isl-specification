/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: logic.isl.md
 * Edit the ISL file instead.
 */

import { IconSize, GridCell } from './domain';

// Default transparent color as per specification for initializing grids
const DEFAULT_TRANSPARENT_COLOR = "#00000000";

/**
 * IconEditorEngine is a business logic component that manages the state and operations
 * of an icon grid editor. It provides capabilities to initialize, modify, and query
 * the icon grid and drawing color.
 *
 * @param {number} initialSize - The starting size for the icon grid (e.g., 16, 32, 64).
 * @param {string} initialColor - The starting drawing color (e.g., "#RRGGBB").
 * @returns {object} An object containing the engine's capabilities.
 */
export const IconEditorEngine = (initialSize, initialColor) => {
  let currentGrid;
  let currentSize = initialSize;
  let currentDrawingColor = initialColor;

  /**
   * Helper function to create a new empty icon grid of the specified size,
   * filling all cells with a default transparent color.
   * @param {number} size - The dimension for the square grid.
   * @returns {ReturnType<typeof GridCell>[][]} A new icon grid.
   */
  const createNewGrid = (size) => {
    const newGrid = [];
    for (let i = 0; i < size; i++) {
      const row = [];
      for (let j = 0; j < size; j++) {
        row.push(GridCell({ x: j, y: i, color: DEFAULT_TRANSPARENT_COLOR }));
      }
      newGrid.push(row);
    }
    return newGrid;
  };

  /**
   * Creates a new empty icon grid of the specified size, filling all cells with a default transparent color.
   * @param {number} size - The starting size for the icon grid.
   */
  const initializeGrid = (size) => {
    currentSize = size;
    currentGrid = createNewGrid(size);
  };

  /**
   * Changes the color of a specific pixel in the icon grid.
   * @param {number} x - The horizontal coordinate.
   * @param {number} y - The vertical coordinate.
   * @param {string} color - The new color for the pixel.
   */
  const setPixel = (x, y, color) => {
    // Flow: 1. IF x is less than 0 OR x is greater than or equal to the current icon size THEN Do nothing.
    // Flow: 2. IF y is less than 0 OR y is greater than or equal to the current icon size THEN Do nothing.
    if (x < 0 || x >= currentSize || y < 0 || y >= currentSize) {
      return;
    }

    // Flow: 3. THEN Update the GridCell at (x, y) in the internal IconGrid with the provided color.
    // Ensure immutability by creating new row and cell objects
    currentGrid = currentGrid.map((row, rowIndex) => {
      if (rowIndex === y) {
        return row.map((cell, colIndex) => {
          if (colIndex === x) {
            return GridCell({ ...cell, color: color }); // Create a new GridCell object with updated color
          }
          return cell;
        });
      }
      return row;
    });
  };

  /**
   * Provides the current state of the icon grid.
   * @returns {ReturnType<typeof GridCell>[][]} The current icon grid.
   */
  const getGrid = () => {
    // Return a shallow copy of the grid (array of arrays) to prevent direct external mutation
    // of the grid structure. GridCell objects are plain objects and are effectively value objects.
    return currentGrid.map(row => [...row]);
  };

  /**
   * Provides the current size of the icon grid.
   * @returns {number} The current icon size.
   */
  const getIconSize = () => currentSize;

  /**
   * Clears the current icon grid, re-initializing it to the current size with a default transparent color.
   */
  const resetGrid = () => {
    // Flow: 1. Retrieve the current IconSize.
    // Flow: 2. Initialize a new grid of that size, filling all cells with a default transparent color.
    // Flow: 3. Update the internal IconGrid state with the new grid.
    initializeGrid(currentSize);
  };

  /**
   * Provides the currently selected drawing color.
   * @returns {string} The current drawing color.
   */
  const getCurrentDrawingColor = () => currentDrawingColor;

  /**
   * Sets the active drawing color.
   * @param {string} color - The new drawing color.
   */
  const setDrawingColor = (color) => {
    currentDrawingColor = color;
  };

  // Initialize the grid when the engine is created
  initializeGrid(initialSize);

  return {
    initializeGrid,
    setPixel,
    getGrid,
    getIconSize,
    resetGrid,
    getCurrentDrawingColor,
    setDrawingColor,
  };
};