/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: main.isl.md
 * Edit the ISL file instead.
 */

import React, { useState, useEffect, useCallback } from 'react';

// Import from REAL IMPLEMENTATION CONTEXT
// ExpenseCategoryType is a runtime object, used for category values if needed directly,
// but primarily passed through props to ExpenseForm.
// ExpenseCategoryTypeValues is a type, not imported at runtime.
import { addExpense, getExpenses, getTotalExpenses } from "./expense-logic";
import ExpenseForm from "./expense-form";
import ExpenseList from "./expense-list";

/**
 * @typedef {import('./domain').ExpenseCategoryTypeValues} ExpenseCategoryTypeValues
 */

// Component: Main
// Role: Presentation
// Signature: None
export default function Main() {
  const [expenses, setExpenses] = useState([]);
  const [totalExpenses, setTotalExpenses] = useState(0);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Capability: initializeApplication
  // Contract: Sets up the initial state of the application and renders the initial UI.
  // Flow:
  // 1. Initialize ExpenseLogic to manage expenses. (Implicitly done by importing and calling functions)
  // 2. Retrieve the initial list of expenses from ExpenseLogic.getExpenses.
  // 3. Calculate the initial total from ExpenseLogic.getTotalExpenses.
  // 4. Render ExpenseForm, passing handleNewExpense as the onAddExpense callback.
  // 5. Render ExpenseList, passing the initial expenses and total.
  useEffect(() => {
    const initialize = async () => {
      try {
        setLoading(true);
        setError(null);
        const initialExpenses = await getExpenses();
        const initialTotal = await getTotalExpenses();
        setExpenses(initialExpenses);
        setTotalExpenses(initialTotal);
      } catch (err) {
        console.error("Failed to initialize application:", err);
        setError("Failed to load initial data. Please try again.");
      } finally {
        setLoading(false);
      }
    };
    initialize();
  }, []); // Empty dependency array ensures this runs once on mount

  // Capability: handleNewExpense
  // Contract: Processes a new expense submitted by the ExpenseForm and updates the display.
  // Signature:
  // - Input: { amount: number, description: string, date: string, category: ExpenseCategoryType }
  // - Output: None
  // Flow:
  // 1. Pass the received expense data to ExpenseLogic.addExpense.
  // 2. Request the updated list of expenses from ExpenseLogic.getExpenses.
  // 3. Request the updated total expenses from ExpenseLogic.getTotalExpenses.
  // 4. Trigger ExpenseList to update its display with the new list of expenses and the new total.
  const handleNewExpense = useCallback(async (expenseData) => {
    try {
      // 1. Pass the received expense data to ExpenseLogic.addExpense.
      await addExpense(expenseData);

      // 2. Request the updated list of expenses from ExpenseLogic.getExpenses.
      const updatedExpenses = await getExpenses();
      // 3. Request the updated total expenses from ExpenseLogic.getTotalExpenses.
      const updatedTotal = await getTotalExpenses();

      // 4. Trigger ExpenseList to update its display with the new list of expenses and the new total.
      setExpenses(updatedExpenses);
      setTotalExpenses(updatedTotal);
      setError(null); // Clear any previous errors on successful operation
    } catch (err) {
      console.error("Failed to add new expense:", err);
      setError("Failed to add expense. Please check your input and try again.");
    }
  }, []); // Dependencies (setExpenses, setTotalExpenses) are stable setters

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-screen bg-gray-100">
        <p className="text-lg text-gray-700">Loading expenses...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex justify-center items-center min-h-screen bg-gray-100">
        <p className="text-lg text-red-600 p-4 bg-red-100 border border-red-400 rounded-md">{error}</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8">
      <h1 className="text-4xl font-bold text-center text-gray-800 mb-8">Personal Expense Tracker</h1>

      <div className="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6 mb-8">
        <h2 className="text-2xl font-semibold text-gray-700 mb-4">Add New Expense</h2>
        <ExpenseForm onAddExpense={handleNewExpense} />
      </div>

      <div className="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6">
        <ExpenseList expenses={expenses} total={totalExpenses} />
      </div>
    </div>
  );
}