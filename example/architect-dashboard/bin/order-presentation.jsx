/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: order-presentation.isl.md
 * Edit the ISL file instead.
 */

import React, { useState, useEffect, useCallback } from 'react';
import {
  fetchOrders,
  fetchOrderById,
  updateOrderStatus,
  processOrderReturn,
  OrderStatus as OrderLogicOrderStatus,
  Order as OrderLogicFactory,
  OrderItem as OrderLogicOrderItemFactory,
} from './order-logic';

// Helper to format date strings
const formatDate = (dateString) => {
  if (!dateString) return 'N/A';
  try {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  } catch (e) {
    return dateString; // Fallback if invalid date string
  }
};

/**
 * OrderStatusUpdateTool Component
 * Allows updating the status of an order.
 */
function OrderStatusUpdateTool({ orderId, currentStatus, onStatusChange }) {
  const [selectedStatus, setSelectedStatus] = useState(currentStatus);

  useEffect(() => {
    setSelectedStatus(currentStatus);
  }, [currentStatus]);

  const handleStatusSelection = useCallback((event) => {
    setSelectedStatus(event.target.value);
  }, []);

  const handleConfirmUpdate = useCallback(() => {
    if (selectedStatus && selectedStatus !== currentStatus) {
      onStatusChange(orderId, selectedStatus);
    }
  }, [orderId, selectedStatus, currentStatus, onStatusChange]);

  const availableStatuses = Object.values(OrderLogicOrderStatus);

  return (
    <div className="p-4 border rounded-lg shadow-sm bg-white">
      <h3 className="text-lg font-semibold mb-2">Update Order Status</h3>
      <p className="mb-2">
        Current Status: <span className="font-medium">{currentStatus}</span>
      </p>
      <div className="flex items-center space-x-2">
        <select
          value={selectedStatus}
          onChange={handleStatusSelection}
          className="p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
        >
          {availableStatuses.map((status) => (
            <option key={status} value={status}>
              {status}
            </option>
          ))}
        </select>
        <button
          onClick={handleConfirmUpdate}
          disabled={selectedStatus === currentStatus}
          className={`px-4 py-2 rounded-md text-white ${
            selectedStatus === currentStatus
              ? 'bg-gray-400 cursor-not-allowed'
              : 'bg-blue-600 hover:bg-blue-700'
          }`}
        >
          Update Status
        </button>
      </div>
    </div>
  );
}

/**
 * OrderDetailView Component
 * Displays comprehensive details of a single order.
 */
function OrderDetailView({ order, onStatusUpdate, onReturnProcess, onBackToList }) {
  const [isProcessingReturn, setIsProcessingReturn] = useState(false);
  const [returnError, setReturnError] = useState(null);

  const handleProcessReturn = useCallback(async () => {
    if (!order?.id || !order?.items?.length) {
      alert("Cannot process return: Order or items are missing.");
      return;
    }

    const returnReason = window.prompt("Please enter a reason for the return:");
    if (!returnReason) {
      return; // User cancelled
    }

    const itemsToReturn = order.items.map(item => ({
      productId: item.productId,
      quantity: item.quantity, // Assuming all items are returned with their original quantity
    }));

    if (!window.confirm(`Confirm return for order ${order.id}? All ${itemsToReturn.length} items will be marked for return.`)) {
      return;
    }

    setIsProcessingReturn(true);
    setReturnError(null);
    try {
      await onReturnProcess(order.id, itemsToReturn, returnReason);
      alert("Return processed successfully!");
      // Parent component (OrderDashboardPage) will handle refreshing the order data
    } catch (err) {
      setReturnError(err.message || "Failed to process return.");
      alert(`Error processing return: ${err.message || "Unknown error"}`);
    } finally {
      setIsProcessingReturn(false);
    }
  }, [order, onReturnProcess]);

  if (!order) {
    return (
      <div className="p-4 text-center text-gray-600">
        <p>No order details available.</p>
        <button
          onClick={onBackToList}
          className="mt-4 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300"
        >
          Back to Order List
        </button>
      </div>
    );
  }

  return (
    <div className="p-6 bg-gray-50 min-h-screen">
      <div className="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-3xl font-bold text-gray-800">Order Details #{order.id}</h2>
          <button
            onClick={onBackToList}
            className="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300"
          >
            Back to Order List
          </button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <h3 className="text-xl font-semibold text-gray-700 mb-3">Order Summary</h3>
            <p><strong>Order ID:</strong> {order.id}</p>
            <p><strong>Customer ID:</strong> {order.customerId}</p>
            <p><strong>Order Date:</strong> {formatDate(order.date)}</p>
            <p><strong>Total Amount:</strong> ${order.totalAmount?.toFixed(2) || '0.00'}</p>
            <p><strong>Status:</strong> <span className={`font-semibold ${order.status === OrderLogicOrderStatus.DELIVERED ? 'text-green-600' : order.status === OrderLogicOrderStatus.CANCELLED ? 'text-red-600' : 'text-blue-600'}`}>{order.status}</span></p>
          </div>
          <div>
            <h3 className="text-xl font-semibold text-gray-700 mb-3">Shipping & Payment</h3>
            <p><strong>Shipping Address:</strong> {order.shippingAddress || 'N/A'}</p>
            <p><strong>Billing Address:</strong> {order.billingAddress || 'N/A'}</p>
            <p><strong>Payment Status:</strong> {order.paymentStatus || 'N/A'}</p>
          </div>
        </div>

        <div className="mb-6">
          <h3 className="text-xl font-semibold text-gray-700 mb-3">Ordered Items</h3>
          {order.items?.length > 0 ? (
            <div className="overflow-x-auto">
              <table className="min-w-full bg-white border border-gray-200 rounded-lg">
                <thead>
                  <tr className="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                    <th className="py-3 px-6 border-b">Product ID</th>
                    <th className="py-3 px-6 border-b">Product Name</th>
                    <th className="py-3 px-6 border-b">Quantity</th>
                    <th className="py-3 px-6 border-b">Unit Price</th>
                    <th className="py-3 px-6 border-b">Subtotal</th>
                  </tr>
                </thead>
                <tbody className="text-gray-700 text-sm font-light">
                  {order.items.map((item, index) => (
                    <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                      <td className="py-3 px-6">{item.productId}</td>
                      <td className="py-3 px-6">{item.productName || 'N/A'}</td>
                      <td className="py-3 px-6">{item.quantity}</td>
                      <td className="py-3 px-6">${item.unitPrice?.toFixed(2) || '0.00'}</td>
                      <td className="py-3 px-6">${item.subtotal?.toFixed(2) || '0.00'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            <p className="text-gray-500">No items in this order.</p>
          )}
        </div>

        <div className="flex flex-col md:flex-row gap-6">
          <div className="flex-1">
            <OrderStatusUpdateTool
              orderId={order.id}
              currentStatus={order.status}
              onStatusChange={onStatusUpdate}
            />
          </div>
          <div className="flex-1 p-4 border rounded-lg shadow-sm bg-white">
            <h3 className="text-lg font-semibold mb-2">Return Management</h3>
            <button
              onClick={handleProcessReturn}
              disabled={isProcessingReturn}
              className={`px-4 py-2 rounded-md text-white ${
                isProcessingReturn ? 'bg-yellow-400 cursor-not-allowed' : 'bg-yellow-600 hover:bg-yellow-700'
              }`}
            >
              {isProcessingReturn ? 'Processing Return...' : 'Process Return'}
            </button>
            {returnError && <p className="text-red-500 text-sm mt-2">{returnError}</p>}
          </div>
        </div>
      </div>
    </div>
  );
}

/**
 * OrderListView Component
 * Displays a list of orders in a table format.
 */
function OrderListView({ orders, onSelectOrder }) {
  return (
    <div className="p-6 bg-gray-50 min-h-screen">
      <div className="max-w-6xl mx-auto bg-white shadow-lg rounded-lg p-6">
        <h2 className="text-3xl font-bold text-gray-800 mb-6">All Orders</h2>
        {orders.length > 0 ? (
          <div className="overflow-x-auto">
            <table className="min-w-full bg-white border border-gray-200 rounded-lg">
              <thead>
                <tr className="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                  <th className="py-3 px-6 border-b">Order ID</th>
                  <th className="py-3 px-6 border-b">Customer ID</th>
                  <th className="py-3 px-6 border-b">Date</th>
                  <th className="py-3 px-6 border-b">Total Amount</th>
                  <th className="py-3 px-6 border-b">Status</th>
                  <th className="py-3 px-6 border-b">Actions</th>
                </tr>
              </thead>
              <tbody className="text-gray-700 text-sm font-light">
                {orders.map((order) => (
                  <tr key={order.id} className="border-b border-gray-200 hover:bg-gray-50">
                    <td className="py-3 px-6">{order.id}</td>
                    <td className="py-3 px-6">{order.customerId}</td>
                    <td className="py-3 px-6">{formatDate(order.date)}</td>
                    <td className="py-3 px-6">${order.totalAmount?.toFixed(2) || '0.00'}</td>
                    <td className="py-3 px-6">
                      <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                        order.status === OrderLogicOrderStatus.DELIVERED ? 'bg-green-200 text-green-800' :
                        order.status === OrderLogicOrderStatus.CANCELLED ? 'bg-red-200 text-red-800' :
                        'bg-blue-200 text-blue-800'
                      }`}>
                        {order.status}
                      </span>
                    </td>
                    <td className="py-3 px-6">
                      <button
                        onClick={() => onSelectOrder(order.id)}
                        className="px-3 py-1 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 text-xs"
                      >
                        View Details
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <p className="text-center text-gray-600">No orders found.</p>
        )}
      </div>
    </div>
  );
}

/**
 * OrderDashboardPage Component
 * The main container for the order management dashboard, handling view switching and data fetching.
 */
export default function OrderDashboardPage() {
  const [orders, setOrders] = useState([]);
  const [currentOrder, setCurrentOrder] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  // InitializeOrderDashboard Capability
  const initializeOrderDashboard = useCallback(async () => {
    setIsLoading(true);
    setError(null);
    try {
      const { orders: fetchedOrders } = await fetchOrders();
      setOrders(fetchedOrders);
    } catch (err) {
      setError(err.message || 'Failed to fetch orders.');
      console.error('Error fetching orders:', err);
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    initializeOrderDashboard();
  }, [initializeOrderDashboard]);

  // NavigateToOrderDetails Capability
  const navigateToOrderDetails = useCallback(async (orderId) => {
    setIsLoading(true);
    setError(null);
    try {
      const order = await fetchOrderById(orderId);
      if (order) {
        setCurrentOrder(order);
      } else {
        setError('Order not found.');
      }
    } catch (err) {
      setError(err.message || 'Failed to fetch order details.');
      console.error('Error fetching order details:', err);
    } finally {
      setIsLoading(false);
    }
  }, []);

  // NavigateBackToList Capability
  const navigateBackToList = useCallback(() => {
    setCurrentOrder(null);
    // Optionally re-fetch the list to ensure it's up-to-date after detail view actions
    initializeOrderDashboard();
  }, [initializeOrderDashboard]);

  // RequestStatusUpdate Capability (passed to OrderDetailView)
  const handleStatusUpdate = useCallback(async (orderId, newStatus) => {
    setIsLoading(true);
    setError(null);
    try {
      const updatedOrder = await updateOrderStatus(orderId, newStatus);
      setCurrentOrder(updatedOrder); // Refresh current order with updated data
      alert(`Order ${orderId} status updated to ${newStatus}.`);
    } catch (err) {
      setError(err.message || 'Failed to update order status.');
      alert(`Error updating status: ${err.message || "Unknown error"}`);
      console.error('Error updating order status:', err);
    } finally {
      setIsLoading(false);
    }
  }, []);

  // RequestReturnProcessing Capability (passed to OrderDetailView)
  const handleReturnProcess = useCallback(async (orderId, itemsToReturn, returnReason) => {
    setIsLoading(true);
    setError(null);
    try {
      await processOrderReturn(orderId, itemsToReturn, returnReason);
      // After return, refresh the current order to reflect changes
      const updatedOrder = await fetchOrderById(orderId);
      if (updatedOrder) {
        setCurrentOrder(updatedOrder);
      }
      // The alert is handled by OrderDetailView
    } catch (err) {
      setError(err.message || 'Failed to process order return.');
      // The alert is handled by OrderDetailView
      console.error('Error processing order return:', err);
      throw err; // Re-throw to allow OrderDetailView to catch and display
    } finally {
      setIsLoading(false);
    }
  }, []);


  if (isLoading) {
    return (
      <div className="flex justify-center items-center h-screen bg-gray-100">
        <p className="text-xl text-gray-700">Loading orders...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex flex-col justify-center items-center h-screen bg-red-50">
        <p className="text-xl text-red-700">Error: {error}</p>
        <button
          onClick={initializeOrderDashboard}
          className="mt-4 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="order-dashboard-page">
      {currentOrder ? (
        <OrderDetailView
          order={currentOrder}
          onStatusUpdate={handleStatusUpdate}
          onReturnProcess={handleReturnProcess}
          onBackToList={navigateBackToList}
        />
      ) : (
        <OrderListView
          orders={orders}
          onSelectOrder={navigateToOrderDetails}
        />
      )}
    </div>
  );
}