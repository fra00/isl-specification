/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: product-presentation.isl.md
 * Edit the ISL file instead.
 */

import React, { useState, useEffect, useCallback } from 'react';

// --- Inferred Domain Entities (from domain.isl.md) ---
// For each Entity (e.g. `User`), generate an exported Factory Function with the SAME PascalCase name (e.g. `export const User = (data) => ({...})`).
// NO `create`/`make` prefixes.
export const Product = (data = {}) => ({
  id: data.id || `prod-${Math.random().toString(36).substr(2, 9)}`, // Generate a simple ID if not provided
  name: data.name || '',
  description: data.description || '',
  price: data.price != null ? parseFloat(data.price) : 0,
  stock: data.stock != null ? parseInt(data.stock, 10) : 0,
  category: data.category || '',
});

// --- Inferred Backend Logic Stubs (from product-logic.isl.md) ---
// These functions simulate API calls. In a real app, they would interact with a backend.
// They are designed to be async and return Promises.

let mockProducts = [
  Product({ id: 'p1', name: 'Laptop Pro', description: 'High-performance laptop', price: 1200.00, stock: 15, category: 'Electronics' }),
  Product({ id: 'p2', name: 'Mechanical Keyboard', description: 'RGB gaming keyboard', price: 99.99, stock: 50, category: 'Accessories' }),
  Product({ id: 'p3', name: 'Wireless Mouse', description: 'Ergonomic wireless mouse', price: 25.50, stock: 120, category: 'Accessories' }),
  Product({ id: 'p4', name: '4K Monitor', description: '27-inch UHD monitor', price: 350.00, stock: 30, category: 'Electronics' }),
];

const simulateDelay = (ms = 500) => new Promise(resolve => setTimeout(resolve, ms));

export async function GetAllProducts() {
  await simulateDelay();
  return [...mockProducts];
}

export async function GetProductById(productId) {
  await simulateDelay();
  return mockProducts.find(p => p.id === productId) || null;
}

export async function AddProduct(productDetails) {
  await simulateDelay();
  const newProduct = Product(productDetails);
  mockProducts.push(newProduct);
  return newProduct;
}

export async function UpdateProduct(productDetails) {
  await simulateDelay();
  const index = mockProducts.findIndex(p => p.id === productDetails.id);
  if (index !== -1) {
    mockProducts[index] = Product({ ...mockProducts[index], ...productDetails });
    return mockProducts[index];
  }
  throw new Error('Product not found for update');
}

export async function DeleteProduct(productId) {
  await simulateDelay();
  const initialLength = mockProducts.length;
  mockProducts = mockProducts.filter(p => p.id !== productId);
  if (mockProducts.length === initialLength) {
    throw new Error('Product not found for deletion');
  }
  return true;
}

// --- Component: ProductListDisplay ---
function ProductListDisplay({ products = [], onProductSelected, onAddProductRequested, onEditProductRequested, onDeleteProductRequested }) {
  return (
    <div className="p-4 bg-white shadow rounded-lg">
      <h2 className="text-2xl font-bold mb-4">Product Management</h2>
      <button
        onClick={onAddProductRequested}
        className="mb-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
      >
        Add New Product
      </button>

      {products.length === 0 ? (
        <p className="text-gray-600">No products available. Add a new one!</p>
      ) : (
        <div className="overflow-x-auto">
          <table className="min-w-full bg-white border border-gray-200">
            <thead>
              <tr className="bg-gray-100 text-left text-gray-600 uppercase text-sm leading-normal">
                <th className="py-3 px-6 border-b border-gray-200">Product Name</th>
                <th className="py-3 px-6 border-b border-gray-200">Price</th>
                <th className="py-3 px-6 border-b border-gray-200">Stock</th>
                <th className="py-3 px-6 border-b border-gray-200">Category</th>
                <th className="py-3 px-6 border-b border-gray-200 text-center">Actions</th>
              </tr>
            </thead>
            <tbody className="text-gray-700 text-sm font-light">
              {products.map(product => (
                <tr key={product.id} className="border-b border-gray-200 hover:bg-gray-50">
                  <td className="py-3 px-6 whitespace-nowrap">{product.name}</td>
                  <td className="py-3 px-6 whitespace-nowrap">${product.price.toFixed(2)}</td>
                  <td className="py-3 px-6 whitespace-nowrap">{product.stock}</td>
                  <td className="py-3 px-6 whitespace-nowrap">{product.category}</td>
                  <td className="py-3 px-6 text-center">
                    <div className="flex item-center justify-center space-x-2">
                      <button
                        onClick={() => onProductSelected(product.id)}
                        className="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400"
                      >
                        View Details
                      </button>
                      <button
                        onClick={() => onEditProductRequested(product.id)}
                        className="px-3 py-1 text-xs bg-yellow-500 text-white rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                      >
                        Edit
                      </button>
                      <button
                        onClick={() => onDeleteProductRequested(product.id)}
                        className="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400"
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

// --- Component: ProductDetailDisplay ---
function ProductDetailDisplay({ product, onEditProductRequested, onDeleteProductRequested, onBackToListRequested }) {
  if (!product) {
    return <div className="p-4 bg-white shadow rounded-lg text-red-600">Product details not found.</div>;
  }

  return (
    <div className="p-4 bg-white shadow rounded-lg">
      <h2 className="text-2xl font-bold mb-4">{product.name}</h2>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <p className="font-semibold">ID:</p>
          <p>{product.id}</p>
        </div>
        <div>
          <p className="font-semibold">Name:</p>
          <p>{product.name}</p>
        </div>
        <div>
          <p className="font-semibold">Description:</p>
          <p>{product.description || 'N/A'}</p>
        </div>
        <div>
          <p className="font-semibold">Price:</p>
          <p>${product.price.toFixed(2)}</p>
        </div>
        <div>
          <p className="font-semibold">Stock:</p>
          <p>{product.stock}</p>
        </div>
        <div>
          <p className="font-semibold">Category:</p>
          <p>{product.category}</p>
        </div>
      </div>
      <div className="flex space-x-2">
        <button
          onClick={() => onEditProductRequested(product.id)}
          className="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-opacity-50"
        >
          Edit Product
        </button>
        <button
          onClick={() => onDeleteProductRequested(product.id)}
          className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50"
        >
          Delete Product
        </button>
        <button
          onClick={onBackToListRequested}
          className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
        >
          Back to List
        </button>
      </div>
    </div>
  );
}

// --- Component: ProductForm ---
function ProductForm({ initialProductDetails = Product(), onSubmit, onCancel }) {
  const [productData, setProductData] = useState(initialProductDetails);
  const [errors, setErrors] = useState({});

  useEffect(() => {
    setProductData(initialProductDetails);
    setErrors({}); // Clear errors when initialProductDetails changes
  }, [initialProductDetails]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setProductData(prev => ({ ...prev, [name]: value }));
    // Clear error for the field being edited
    if (errors[name]) {
      setErrors(prev => {
        const newErrors = { ...prev };
        delete newErrors[name];
        return newErrors;
      });
    }
  };

  const validateForm = () => {
    const newErrors = {};
    if (!productData.name.trim()) {
      newErrors.name = 'Product Name is required.';
    }
    const price = parseFloat(productData.price);
    if (isNaN(price) || price <= 0) {
      newErrors.price = 'Price must be a positive number.';
    }
    const stock = parseInt(productData.stock, 10);
    if (isNaN(stock) || stock < 0) {
      newErrors.stock = 'Stock must be a non-negative integer.';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validateForm()) {
      onSubmit(Product(productData)); // Ensure data is consistent with Product factory
    }
  };

  // The "Save" button MUST be disabled or prevent submission if client-side validation fails.
  // We check if there are any errors that are not empty strings.
  const isSaveDisabled = Object.values(errors).some(errorMsg => errorMsg);

  return (
    <div className="p-4 bg-white shadow rounded-lg">
      <h2 className="text-2xl font-bold mb-4">{initialProductDetails.id ? 'Edit Product' : 'Add New Product'}</h2>
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label htmlFor="name" className="block text-sm font-medium text-gray-700">Product Name</label>
          <input
            type="text"
            id="name"
            name="name"
            value={productData.name}
            onChange={handleChange}
            className={`mt-1 block w-full border ${errors.name ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500`}
          />
          {errors.name && <p className="mt-1 text-sm text-red-600">{errors.name}</p>}
        </div>

        <div>
          <label htmlFor="description" className="block text-sm font-medium text-gray-700">Description</label>
          <textarea
            id="description"
            name="description"
            value={productData.description}
            onChange={handleChange}
            rows="3"
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
          ></textarea>
        </div>

        <div>
          <label htmlFor="price" className="block text-sm font-medium text-gray-700">Price</label>
          <input
            type="number"
            id="price"
            name="price"
            value={productData.price}
            onChange={handleChange}
            step="0.01"
            className={`mt-1 block w-full border ${errors.price ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500`}
          />
          {errors.price && <p className="mt-1 text-sm text-red-600">{errors.price}</p>}
        </div>

        <div>
          <label htmlFor="stock" className="block text-sm font-medium text-gray-700">Stock</label>
          <input
            type="number"
            id="stock"
            name="stock"
            value={productData.stock}
            onChange={handleChange}
            step="1"
            className={`mt-1 block w-full border ${errors.stock ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500`}
          />
          {errors.stock && <p className="mt-1 text-sm text-red-600">{errors.stock}</p>}
        </div>

        <div>
          <label htmlFor="category" className="block text-sm font-medium text-gray-700">Category</label>
          <input
            type="text"
            id="category"
            name="category"
            value={productData.category}
            onChange={handleChange}
            className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div className="flex justify-end space-x-2">
          <button
            type="button"
            onClick={onCancel}
            className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
          >
            Cancel
          </button>
          <button
            type="submit"
            disabled={isSaveDisabled}
            className={`px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 ${isSaveDisabled ? 'opacity-50 cursor-not-allowed' : ''}`}
          >
            Save
          </button>
        </div>
      </form>
    </div>
  );
}

// --- Component: ProductManagementPage ---
export default function ProductManagementPage() {
  const [currentView, setCurrentView] = useState('list'); // 'list', 'details', 'add', 'edit'
  const [products, setProducts] = useState([]);
  const [selectedProductId, setSelectedProductId] = useState(null);
  const [productDetailsForView, setProductDetailsForView] = useState(null); // For details/edit view
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Capability: ShowProductList
  const showProductList = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const allProducts = await GetAllProducts();
      setProducts(allProducts);
      setCurrentView('list');
      setSelectedProductId(null);
      setProductDetailsForView(null);
    } catch (err) {
      console.error("Failed to fetch products:", err);
      setError("Failed to load products. Please try again.");
    } finally {
      setLoading(false);
    }
  }, []);

  // Capability: ShowProductDetails
  const showProductDetails = useCallback(async (productId) => {
    setLoading(true);
    setError(null);
    try {
      const product = await GetProductById(productId);
      if (product) {
        setProductDetailsForView(product);
        setSelectedProductId(productId);
        setCurrentView('details');
      } else {
        setError("Product not found.");
        setCurrentView('list'); // Fallback to list if product not found
      }
    } catch (err) {
      console.error("Failed to fetch product details:", err);
      setError("Failed to load product details. Please try again.");
    } finally {
      setLoading(false);
    }
  }, []);

  // Capability: ShowAddProductForm
  const showAddProductForm = useCallback(() => {
    setCurrentView('add');
    setSelectedProductId(null);
    setProductDetailsForView(Product()); // Provide an empty product for new creation
  }, []);

  // Capability: ShowEditProductForm
  const showEditProductForm = useCallback(async (productId) => {
    setLoading(true);
    setError(null);
    try {
      const product = await GetProductById(productId);
      if (product) {
        setProductDetailsForView(product);
        setSelectedProductId(productId);
        setCurrentView('edit');
      } else {
        setError("Product not found for editing.");
        setCurrentView('list'); // Fallback to list if product not found
      }
    } catch (err) {
      console.error("Failed to fetch product for editing:", err);
      setError("Failed to load product for editing. Please try again.");
    } finally {
      setLoading(false);
    }
  }, []);

  // Capability: Initialize (on mount)
  useEffect(() => {
    showProductList();
  }, [showProductList]);

  // Capability: HandleProductSelected
  const handleProductSelected = useCallback((productId) => {
    showProductDetails(productId);
  }, [showProductDetails]);

  // Capability: HandleAddProductRequested
  const handleAddProductRequested = useCallback(() => {
    showAddProductForm();
  }, [showAddProductForm]);

  // Capability: HandleEditProductRequested
  const handleEditProductRequested = useCallback((productId) => {
    showEditProductForm(productId);
  }, [showEditProductForm]);

  // Capability: HandleDeleteProductRequested
  const handleDeleteProductRequested = useCallback(async (productId) => {
    if (!window.confirm("Are you sure you want to delete this product?")) {
      return;
    }
    setLoading(true);
    setError(null);
    try {
      await DeleteProduct(productId);
      await showProductList(); // Refresh list
    } catch (err) {
      console.error("Failed to delete product:", err);
      setError(`Failed to delete product: ${err.message}.`);
    } finally {
      setLoading(false);
    }
  }, [showProductList]);

  // Capability: HandleProductFormSubmit
  const handleProductFormSubmit = useCallback(async (productDetails) => {
    setLoading(true);
    setError(null);
    try {
      if (currentView === 'add') {
        await AddProduct(productDetails);
        await showProductList();
      } else if (currentView === 'edit') {
        await UpdateProduct(productDetails);
        await showProductDetails(productDetails.id); // Go back to details of the updated product
      }
    } catch (err) {
      console.error("Failed to save product:", err);
      setError(`Failed to save product: ${err.message}.`);
    } finally {
      setLoading(false);
    }
  }, [currentView, showProductList, showProductDetails]);

  // Capability: HandleProductFormCancel
  const handleProductFormCancel = useCallback(() => {
    if (selectedProductId) {
      showProductDetails(selectedProductId);
    } else {
      showProductList();
    }
  }, [selectedProductId, showProductDetails, showProductList]);

  // Capability: HandleBackToListRequested
  const handleBackToListRequested = useCallback(() => {
    showProductList();
  }, [showProductList]);

  return (
    <div className="container mx-auto p-4">
      {loading && <div className="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50"><div className="text-white text-xl">Loading...</div></div>}
      {error && (
        <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded relative" role="alert">
          <strong className="font-bold">Error!</strong>
          <span className="block sm:inline"> {error}</span>
          <span className="absolute top-0 bottom-0 right-0 px-4 py-3" onClick={() => setError(null)}>
            <svg className="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
          </span>
        </div>
      )}

      {currentView === 'list' && (
        <ProductListDisplay
          products={products}
          onProductSelected={handleProductSelected}
          onAddProductRequested={handleAddProductRequested}
          onEditProductRequested={handleEditProductRequested}
          onDeleteProductRequested={handleDeleteProductRequested}
        />
      )}

      {currentView === 'details' && productDetailsForView && (
        <ProductDetailDisplay
          product={productDetailsForView}
          onEditProductRequested={handleEditProductRequested}
          onDeleteProductRequested={handleDeleteProductRequested}
          onBackToListRequested={handleBackToListRequested}
        />
      )}

      {(currentView === 'add' || currentView === 'edit') && (
        <ProductForm
          initialProductDetails={productDetailsForView}
          onSubmit={handleProductFormSubmit}
          onCancel={handleProductFormCancel}
        />
      )}
    </div>
  );
}