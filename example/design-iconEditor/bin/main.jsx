/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: main.isl.md
 * Edit the ISL file instead.
 */

import React, { useState, useRef, useEffect, useCallback } from 'react';

import { IconSize, GridCell } from './domain';
import { IconEditorEngine } from './logic';
import DrawingCanvas, { IconPreview, SizeSelector, ColorPicker, Toolbar } from './ui';

// Define default values
const DEFAULT_ICON_SIZE = IconSize.SIZE_16;
const DEFAULT_DRAWING_COLOR = "#000000"; // Black
const DEFAULT_CELL_SIZE = 12; // Pixels per cell in DrawingCanvas
const DEFAULT_PREVIEW_SIZE = 128; // Pixels for IconPreview

// Helper function to create an empty grid for initial state
const createEmptyGrid = (size, color) => {
  const grid = [];
  for (let y = 0; y < size; y++) {
    const row = [];
    for (let x = 0; x < size; x++) {
      row.push(GridCell({ x, y, color }));
    }
    grid.push(row);
  }
  return grid;
};

export default function Main() {
  // State for the application
  const [grid, setGrid] = useState(() => createEmptyGrid(DEFAULT_ICON_SIZE, DEFAULT_DRAWING_COLOR));
  const [iconSize, setIconSize] = useState(DEFAULT_ICON_SIZE);
  const [drawingColor, setDrawingColor] = useState(DEFAULT_DRAWING_COLOR);

  // Ref for the IconEditorEngine instance to keep it stable across renders
  const editorEngineRef = useRef(null);

  // Capability: initializeApplication
  useEffect(() => {
    // 1. Initialize the IconEditorEngine with a default IconSize (e.g., 16) and a default PixelColor (e.g., "#000000").
    const engine = IconEditorEngine(DEFAULT_ICON_SIZE, DEFAULT_DRAWING_COLOR);
    editorEngineRef.current = engine;

    // 2. Request the engine to initializeGrid with the default size.
    engine.initializeGrid(DEFAULT_ICON_SIZE);

    // 3. Set the initial application state based on the engine's current grid, size, and color.
    setGrid(engine.getGrid());
    setIconSize(engine.getIconSize());
    setDrawingColor(engine.getCurrentDrawingColor());
  }, []); // Empty dependency array ensures this runs only once on mount

  // Capability: handleSizeChange
  const handleSizeChange = useCallback((newSize) => {
    const engine = editorEngineRef.current;
    if (engine) {
      // 1. Request the IconEditorEngine to initializeGrid with newSize.
      engine.initializeGrid(newSize);
      // 2. Update the application state to reflect the new grid and size from the engine.
      setGrid(engine.getGrid());
      setIconSize(engine.getIconSize());
    }
  }, []);

  // Capability: handlePixelClick
  const handlePixelClick = useCallback((x, y) => {
    const engine = editorEngineRef.current;
    if (engine) {
      // 1. Retrieve the currentDrawingColor from the IconEditorEngine.
      const color = engine.getCurrentDrawingColor();
      // 2. Request the IconEditorEngine to setPixel at (x, y) with the currentDrawingColor.
      engine.setPixel(x, y, color);
      // 3. Update the application state to reflect the new grid from the engine.
      setGrid(engine.getGrid()); // Trigger re-render with updated grid
    }
  }, []);

  // Capability: handleColorChange
  const handleColorChange = useCallback((newColor) => {
    const engine = editorEngineRef.current;
    if (engine) {
      // 1. Request the IconEditorEngine to setDrawingColor with newColor.
      engine.setDrawingColor(newColor);
      // 2. Update the application state to reflect the new drawing color from the engine.
      setDrawingColor(engine.getCurrentDrawingColor());
    }
  }, []);

  // Capability: handleClearGrid
  const handleClearGrid = useCallback(() => {
    const engine = editorEngineRef.current;
    if (engine) {
      // 1. Request the IconEditorEngine to resetGrid.
      engine.resetGrid();
      // 2. Update the application state to reflect the cleared grid from the engine.
      setGrid(engine.getGrid());
    }
  }, []);

  return (
    <div className="flex flex-col items-center p-4 bg-gray-100 min-h-screen font-sans">
      <h1 className="text-3xl font-bold mb-6 text-gray-800">Icon Editor</h1>

      <div className="flex flex-col md:flex-row gap-8 w-full max-w-6xl">
        {/* Controls Section */}
        <div className="flex flex-col gap-4 p-4 bg-white shadow-lg rounded-lg md:w-1/4">
          <h2 className="text-xl font-semibold text-gray-700 mb-2">Controls</h2>
          <SizeSelector currentSize={iconSize} onSizeChange={handleSizeChange} />
          <ColorPicker currentColor={drawingColor} onColorChange={handleColorChange} />
          <Toolbar onClear={handleClearGrid} />
        </div>

        {/* Drawing Canvas and Preview Section */}
        <div className="flex flex-col items-center gap-8 p-4 bg-white shadow-lg rounded-lg md:w-3/4">
          <h2 className="text-xl font-semibold text-gray-700 mb-2">Drawing Area</h2>
          <DrawingCanvas
            grid={grid}
            cellSize={DEFAULT_CELL_SIZE}
            onPixelClick={handlePixelClick}
          />
          <h2 className="text-xl font-semibold text-gray-700 mt-4 mb-2">Preview</h2>
          <IconPreview grid={grid} previewSize={DEFAULT_PREVIEW_SIZE} />
        </div>
      </div>
    </div>
  );
}