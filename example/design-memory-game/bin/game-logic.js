/**
 * ðŸ›‘ DO NOT EDIT THIS FILE DIRECTLY
 * ----------------------------------
 * This file was generated by ISL Compiler.
 * Source: game-logic.isl.md
 * Edit the ISL file instead.
 */

import { CardState, CardEntity, GameStatus, GameConfig } from './domain';

// Internal state variables for the GameEngine module
let _config = null;
let _cards = [];
let _flippedCards = []; // Stores CardEntity objects of currently flipped cards (max 2)
let _moves = 0;
let _timerSeconds = 0;
let _gameStatus = GameStatus.NotStarted;
let _timerIntervalId = null;
let _isProcessingFlip = false; // Flag to prevent new flips while a pair is being processed

// --- Internal Helper Functions ---

/**
 * Generates a simple UUID string.
 * @returns {string} A unique identifier.
 */
const _generateUUID = () => {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
};

/**
 * Shuffles an array using the Fisher-Yates algorithm.
 * @param {Array} array The array to shuffle.
 * @returns {Array} A new, shuffled array.
 */
const _shuffleArray = (array) => {
  const newArray = [...array]; // Create a shallow copy to ensure immutability
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
};

/**
 * Generates an array of card values ensuring each value appears exactly twice.
 * @param {number} totalCards The total number of cards needed.
 * @returns {string[]} An array of card values.
 */
const _generateCardValues = (totalCards) => {
  const numPairs = totalCards / 2;
  const values = [];
  for (let i = 0; i < numPairs; i++) {
    const charCode = 65 + i; // Use A, B, C... for values
    const value = String.fromCharCode(charCode);
    values.push(value, value);
  }
  return values;
};

/**
 * Updates the state of one or more cards immutably within the `_cards` array.
 * @param {string[]} cardIds An array of card IDs to update.
 * @param {typeof CardState[keyof typeof CardState]} newState The new state for the cards.
 */
const _updateCardsStates = (cardIds, newState) => {
  _cards = _cards.map(card =>
    cardIds.includes(card.id) ? CardEntity({ ...card, state: newState }) : card
  );
};

/**
 * Clears the game timer if it's active.
 */
const _clearTimer = () => {
  if (_timerIntervalId != null) {
    clearInterval(_timerIntervalId);
    _timerIntervalId = null;
  }
};

/**
 * Checks if all cards are in the `Solved` state and updates game status if true.
 */
const _checkWinCondition = () => {
  const allSolved = _cards.every(card => card.state === CardState.Solved);
  if (allSolved) {
    _gameStatus = GameStatus.Won;
    _clearTimer(); // Stop timer when game is won
  }
};

// --- Exported Capabilities (Business Logic) ---

/**
 * Initializes the GameEngine with the provided configuration.
 * This function must be called once before starting the game.
 * @param {object} configData Configuration parameters for the game.
 */
export const initGameEngine = (configData) => {
  _config = GameConfig(configData);
  // Ensure config values are valid, provide defaults if necessary
  _config.gridSize = _config.gridSize || [4, 4];
  _config.matchDelayMs = _config.matchDelayMs || 1000;

  // Validate gridSize to ensure an even number of cards
  if ((_config.gridSize[0] * _config.gridSize[1]) % 2 !== 0) {
    console.warn("Grid size must result in an even number of cards. Adjusting to [4,4].");
    _config.gridSize = [4, 4];
  }

  initializeGame();
};

/**
 * Sets up the game board with a shuffled set of cards, ensuring an even number of pairs.
 */
export const initializeGame = () => {
  _clearTimer(); // Stop any active timer
  const totalCards = (_config?.gridSize?.[0] || 4) * (_config?.gridSize?.[1] || 4);
  const cardValues = _generateCardValues(totalCards);

  const initialCards = cardValues.map(value =>
    CardEntity({
      id: _generateUUID(),
      value: value,
      state: CardState.Covered,
    })
  );

  _cards = _shuffleArray(initialCards);
  _flippedCards = [];
  _moves = 0;
  _timerSeconds = 0;
  _gameStatus = GameStatus.NotStarted;
  _isProcessingFlip = false;
};

/**
 * Handles the logic when a user attempts to flip a card.
 * Manages card states, match checking, and non-matching card reset.
 * @param {string} cardId The ID of the card to flip.
 */
export const flipCard = (cardId) => {
  // 1. IF gameStatus is not GameStatus.Playing, THEN do nothing.
  if (_gameStatus !== GameStatus.Playing) {
    return;
  }

  // Prevent flipping if a pair is currently being processed
  if (_isProcessingFlip) {
    return;
  }

  // 2. Retrieve the CardEntity corresponding to cardId.
  const cardToFlip = _cards.find(card => card.id === cardId);
  if (!cardToFlip) {
    return; // Card not found
  }

  // 3. IF the card's state is CardState.Flipped or CardState.Solved, THEN do nothing.
  if (cardToFlip.state === CardState.Flipped || cardToFlip.state === CardState.Solved) {
    return;
  }

  // 4. Update the card's state to CardState.Flipped.
  _updateCardsStates([cardId], CardState.Flipped);
  const updatedCardToFlip = _cards.find(card => card.id === cardId); // Get the updated card object

  // 5. Add the card to the list of currently flippedCards.
  _flippedCards = [..._flippedCards, updatedCardToFlip];

  // 6. IF the number of flippedCards is 2:
  if (_flippedCards.length === 2) {
    _isProcessingFlip = true; // Block further flips
    // 6.1. Increment moves counter.
    _moves++;

    const [card1, card2] = _flippedCards;

    // 6.3. IF the value of the two flippedCards match:
    if (card1.value === card2.value) {
      // 6.3.1. Update the state of both flippedCards to CardState.Solved.
      _updateCardsStates([card1.id, card2.id], CardState.Solved);
      // 6.3.2. Clear the list of flippedCards.
      _flippedCards = [];
      _isProcessingFlip = false; // Unblock flips
      // 6.3.3. Check if all cards are CardState.Solved. IF true, THEN set gameStatus to GameStatus.Won.
      _checkWinCondition();
    } else {
      // 6.4. ELSE (values do not match):
      // 6.4.1. After config.matchDelayMs delay:
      setTimeout(() => {
        // 6.4.1.1. Update the state of both flippedCards back to CardState.Covered.
        _updateCardsStates([card1.id, card2.id], CardState.Covered);
        // 6.4.1.2. Clear the list of flippedCards.
        _flippedCards = [];
        _isProcessingFlip = false; // Unblock flips
      }, _config?.matchDelayMs || 1000); // Use default if config is null or matchDelayMs is missing
    }
  }
};

/**
 * Resets the game to its initial state, allowing a new game to begin.
 */
export const resetGame = () => {
  // 1. Stop the game timer.
  _clearTimer();
  // 2. Call initializeGame.
  initializeGame();
};

/**
 * Initiates the game timer, incrementing `timerSeconds` every second.
 */
export const startGameTimer = () => {
  // 1. IF gameStatus is GameStatus.NotStarted or GameStatus.Paused:
  if (_gameStatus === GameStatus.NotStarted || _gameStatus === GameStatus.Paused) {
    // 1.1. Set gameStatus to GameStatus.Playing.
    _gameStatus = GameStatus.Playing;
    // 1.2. Start a recurring process that increments timerSeconds by 1 every 1000 milliseconds.
    _clearTimer(); // Ensure no previous timer is running
    _timerIntervalId = setInterval(() => {
      _timerSeconds++;
    }, 1000);
  }
};

/**
 * Halts the game timer.
 */
export const stopGameTimer = () => {
  // 1. IF gameStatus is GameStatus.Playing:
  if (_gameStatus === GameStatus.Playing) {
    // 1.1. Stop the recurring process that increments timerSeconds.
    _clearTimer();
    // 1.2. Set gameStatus to GameStatus.Paused.
    _gameStatus = GameStatus.Paused;
  }
};

// --- Exported State Getters (for external consumption) ---
// These provide read-only access to the internal state.

/**
 * Returns a copy of the current cards array.
 * @returns {Array<ReturnType<typeof CardEntity>>} An array of card entities.
 */
export const getCards = () => [..._cards];

/**
 * Returns the current number of moves.
 * @returns {number} The number of moves made.
 */
export const getMoves = () => _moves;

/**
 * Returns the current timer seconds.
 * @returns {number} The elapsed time in seconds.
 */
export const constgetTimerSeconds = () => _timerSeconds;

/**
 * Returns the current game status.
 * @returns {typeof GameStatus[keyof typeof GameStatus]} The current status of the game.
 */
export const getGameStatus = () => _gameStatus;

/**
 * Returns a copy of the currently flipped cards.
 * @returns {Array<ReturnType<typeof CardEntity>>} An array of currently flipped card entities.
 */
export const getFlippedCards = () => [..._flippedCards];